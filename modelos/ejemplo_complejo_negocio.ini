# Modelo Complejo: Simulación de Análisis de Negocio
# Fase 3.4 - Ejemplo que usa todas las capacidades del sistema
#
# Este modelo simula la viabilidad de un proyecto de negocio considerando:
# - 6 distribuciones diferentes
# - Función compleja con def modelo()
# - Lógica de negocio realista
# - Validación de sintaxis Python
# - Ejecución segura con RestrictedPython

[METADATA]
nombre = simulacion_negocio_completo
version = 2.0
descripcion = Simulación completa de viabilidad de proyecto de negocio usando las 6 distribuciones y función def modelo()
autor = VarP System - Fase 3.4
fecha_creacion = 2025-01-15

[VARIABLES]
# ============================================================================
# VARIABLES DEL MODELO (6 distribuciones)
# ============================================================================

# 1. NORMAL: Retorno de inversión anual esperado (%)
# Media: 12% anual, Desviación: 8%
roi_anual, float, normal, media=12, std=8

# 2. UNIFORM: Tasa de impuestos efectiva (%)
# Varía entre 15% y 35% según jurisdicción
tasa_impuestos, float, uniform, min=15, max=35

# 3. EXPONENTIAL: Tiempo hasta evento de riesgo mayor (años)
# Lambda = 0.15 (evento cada ~6.7 años en promedio)
tiempo_evento_riesgo, float, exponential, lambda=0.15

# 4. LOGNORMAL: Costo inicial del proyecto ($)
# mu=11.5, sigma=0.4 → media ~$100,000, con variabilidad
costo_inicial, float, lognormal, mu=11.5, sigma=0.4

# 5. TRIANGULAR: Ingresos mensuales proyectados ($)
# Pesimista: $8,000, Probable: $15,000, Optimista: $25,000
ingresos_mensuales, float, triangular, left=8000, mode=15000, right=25000

# 6. BINOMIAL: Número de clientes que convierten (de 50 contactos)
# Tasa de conversión: 30%
clientes_convertidos, int, binomial, n=50, p=0.3

[FUNCION]
tipo = codigo
codigo =
    # ========================================================================
    # SIMULACIÓN DE ANÁLISIS DE NEGOCIO
    # ========================================================================
    import math

    # ------------------------------------------------------------------------
    # Función auxiliar: Calcular VAN (Valor Actual Neto)
    # ------------------------------------------------------------------------
    def calcular_van(flujos, tasa_descuento, inversion_inicial):
        """
        Calcula el Valor Actual Neto de un proyecto.

        Args:
            flujos: Lista de flujos de caja por período
            tasa_descuento: Tasa de descuento anual (decimal)
            inversion_inicial: Inversión inicial (negativa)

        Returns:
            VAN del proyecto
        """
        van = -inversion_inicial

        for periodo, flujo in enumerate(flujos, start=1):
            factor_descuento = (1 + tasa_descuento) ** periodo
            van += flujo / factor_descuento

        return van

    # ------------------------------------------------------------------------
    # Función principal: Modelo de negocio
    # ------------------------------------------------------------------------
    def modelo_negocio():
        """
        Modelo completo de análisis de viabilidad de negocio.

        Considera:
        - Costos iniciales (lognormal)
        - Ingresos mensuales (triangular)
        - Clientes convertidos (binomial)
        - ROI esperado (normal)
        - Impuestos (uniform)
        - Riesgos (exponential)

        Returns:
            Score de viabilidad del proyecto (0-100)
        """
        # 1. Costo inicial del proyecto
        inversion = costo_inicial

        # 2. Ingresos anuales = ingresos_mensuales * 12 * factor_clientes
        # Factor de clientes: proporción de clientes convertidos
        factor_clientes = clientes_convertidos / 50.0
        ingresos_anuales = ingresos_mensuales * 12 * factor_clientes

        # 3. Costos operacionales anuales (40% de ingresos)
        costos_anuales = ingresos_anuales * 0.4

        # 4. Utilidad bruta anual
        utilidad_bruta = ingresos_anuales - costos_anuales

        # 5. Impuestos
        tasa_impuesto_decimal = tasa_impuestos / 100.0
        impuestos = utilidad_bruta * tasa_impuesto_decimal

        # 6. Utilidad neta anual
        utilidad_neta = utilidad_bruta - impuestos

        # 7. Proyectar flujos de caja para 5 años
        # Considerando crecimiento del 5% anual
        flujos_caja = []
        for año in range(1, 6):
            crecimiento = 1.05 ** (año - 1)
            flujo = utilidad_neta * crecimiento
            flujos_caja.append(flujo)

        # 8. Calcular VAN con tasa de descuento = roi_anual
        tasa_descuento = roi_anual / 100.0
        van = calcular_van(flujos_caja, tasa_descuento, inversion)

        # 9. Calcular TIR aproximada (payback period)
        utilidad_anual_promedio = sum(flujos_caja) / len(flujos_caja)
        if utilidad_anual_promedio > 0:
            payback_period = inversion / utilidad_anual_promedio
        else:
            payback_period = 999  # Nunca se recupera

        # 10. Factor de riesgo basado en tiempo hasta evento
        # Si el evento de riesgo ocurre antes del payback, penalizar
        if tiempo_evento_riesgo < payback_period:
            factor_riesgo = 0.5  # 50% de penalización
        else:
            factor_riesgo = 1.0  # Sin penalización

        # 11. Calcular score de viabilidad (0-100)
        # Basado en VAN ajustado por riesgo
        van_ajustado = van * factor_riesgo

        # Normalizar VAN a score 0-100
        # VAN positivo > $50,000 = excelente (100)
        # VAN = 0 = neutral (50)
        # VAN negativo < -$50,000 = muy malo (0)
        if van_ajustado >= 50000:
            score = 100
        elif van_ajustado <= -50000:
            score = 0
        else:
            # Mapeo lineal de [-50000, 50000] a [0, 100]
            score = 50 + (van_ajustado / 50000) * 50

        # Asegurar que score esté en [0, 100]
        score = max(0, min(100, score))

        return score

    # ------------------------------------------------------------------------
    # Ejecutar modelo y asignar resultado
    # ------------------------------------------------------------------------
    resultado = modelo_negocio()

[SIMULACION]
numero_escenarios = 10000
semilla_aleatoria = 42
